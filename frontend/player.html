<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player - Flux</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    
    <!-- Critical CSS -->
    <link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/player.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/ion-rangeslider/css/ion.rangeSlider.min.css">
    <link href="css/triple-slider.css" rel="stylesheet">
    <link href="css/parameter-grid.css" rel="stylesheet">
    <link href="css/tab-components.css" rel="stylesheet">
    <link href="css/thumbnails.css" rel="stylesheet">
    <link href="css/color-picker.css" rel="stylesheet">
    <link href="css/sequences.css" rel="stylesheet">
    <link href="css/bpm-widget.css" rel="stylesheet">
    <link href="css/circular-slider.css" rel="stylesheet">
    <link href="css/playlist-tabs.css" rel="stylesheet">
    <link href="css/transport-controls.css" rel="stylesheet">
    
    <style>
        /* Inline critical CSS for preview placeholder */
        #videoPreviewImg {
            background: #000;
        }
        #videoPreviewImg[src=""] {
            content: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600"%3E%3Crect fill="%23000000" width="800" height="600"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" fill="%23667eea"%3Eüé¨ Loading Preview...%3C/text%3E%3C/svg%3E');
        }
        #artnetPreviewImg {
            background: #000;
        }
        #artnetPreviewImg[src=""] {
            content: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600"%3E%3Crect fill="%23000000" width="800" height="600"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" fill="%23667eea"%3Eüì° Loading Preview...%3C/text%3E%3C/svg%3E');
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- 
        ‚ö†Ô∏è DEPRECATED: OLD PLAYLIST MANAGEMENT BAR - HIDDEN
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        This section is DEPRECATED and replaced by the new Multi-Playlist System.
        The functionality has been superseded by:
        - Multi-playlist management (create/switch/delete multiple playlists)
        - Per-playlist session state (independent clip selections, effects, settings)
        - Improved session save/restore architecture
        
        ‚ö†Ô∏è DO NOT DELETE WITHOUT USER CONFIRMATION!
        This code is preserved temporarily for reference and emergency fallback.
        Before deleting:
        1. Confirm new multi-playlist system is fully operational
        2. Verify all session save/restore functionality works
        3. Test with production workflows
        4. Get explicit user approval
        
        Old functionality (now in new system):
        - savePlaylists()     ‚Üí New: Multi-playlist auto-save + session save
        - loadPlaylists()     ‚Üí New: Session restore
        - Snapshot system     ‚Üí New: Enhanced session snapshots
        - Sequencer toggle    ‚Üí New: Per-playlist sequencer mode
        - Input settings      ‚Üí New: Retained in new UI
        
        To restore if needed: Remove this comment wrapper
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        <div class="playlist-management-bar" style="display: none;">
            <div class="playlist-management-bar-title">
                <span>üìã Playlist Management</span>
            </div>
            <div class="playlist-management-bar-actions">
                <button class="btn btn-success btn-sm" onclick="savePlaylists()" title="Save Both Playlists">üíæ Save Playlists</button>
                <button class="btn btn-primary btn-sm" onclick="SessionManager.createSnapshot()" title="Create Snapshot">üì∏ Snapshot</button>
                <button class="btn btn-info btn-sm" onclick="loadPlaylists()" title="Load Both Playlists">üìÇ Load Playlists</button>
                <button class="btn btn-warning btn-sm" onclick="SessionManager.showLoadModal()" title="Load Snapshot">üîÑ Restore</button>
                <button class="btn btn-outline-secondary btn-sm" id="sequencerModeBtn" onclick="toggleSequencerMode()" title="Toggle Sequencer Mode">üéµ Sequencer Mode</button>
                <button class="btn btn-outline-info btn-sm" onclick="showVideoPlayerSettingsModal()" title="Configure Input Settings">‚öôÔ∏è Input Settings</button>
            </div>
        </div>
        
        END DEPRECATED SECTION -->
        
        <!-- Waveform Analyzer Section -->
        <div class="waveform-analyzer-section" style="display: none;">
            <!-- Preview Box -->
            <div class="preview-box-waveform">
                <div class="preview-area-waveform" id="preview-area-waveform" style="cursor: pointer;">
                    <span>üìä Drag & Drop MP3<br>or Click to Browse</span>
                </div>
                <div class="file-info-waveform" id="waveformFileInfo">No file loaded</div>
                
                <!-- Controls -->
                <div class="controls-waveform">
                    <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
                    <button class="btn btn-sm btn-outline-primary" id="previewBtn" disabled title="Preview (Frontend Only - No Backend Sync)">üëÅÔ∏è Preview</button>
                    <button class="btn btn-sm btn-success" id="playBtn" disabled title="Play Synced (Triggers Backend Audio + Playlist Sync)">‚ñ∂Ô∏è Play Synced</button>
                    <button class="btn btn-sm btn-warning" id="pauseBtn" disabled title="Pause">‚è∏Ô∏è</button>
                    <button class="btn btn-sm btn-danger" id="stopBtn" disabled title="Stop">‚èπÔ∏è</button>
                    <button class="btn btn-sm btn-outline-danger" id="clearSplitsBtn" disabled title="Clear All Splits">üóëÔ∏è</button>
                    <button class="btn btn-sm btn-outline-secondary" id="minifyBtn" title="Minify">‚¨áÔ∏è</button>
                </div>
            </div>
            
            <!-- Spacer -->
            <div class="waveform-spacer"></div>
            
            <!-- Waveform & Playlist Area -->
            <div class="playlist-waveform-area">
                <!-- Waveform -->
                <div class="waveform-container">
                    <div id="waveform"></div>
                    <div class="waveform-help">
                        üí° <strong>Click</strong> on waveform to add split | <strong>Right-click</strong> region to remove | <strong>Click slot</strong> to loop
                    </div>
                    <div class="playback-info" style="margin-top: 8px;">
                        <span><strong>Time:</strong> <span id="currentTime">0:00</span> / <span id="duration">0:00</span></span>
                        <span style="margin-left: 12px;"><strong>Slot:</strong> <span id="currentSlot" class="info-badge">None</span></span>
                    </div>
                </div>
                
                <!-- Slots Playlist -->
                <div class="slots-container" id="slotsContainer">
                    <div id="slotsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Video Player Section -->
        <div class="player-section">
            <!-- Preview -->
            <div class="preview-box">
                <div class="preview-video" id="videoPreview" onclick="openVideoFullscreen()" title="Click to open fullscreen">
                    <canvas id="videoPreviewVideo" style="width: 100%; height: 100%; object-fit: contain; display: none;"></canvas>
                    <img src="" alt="Video Preview" id="videoPreviewImg" 
                         width="800" height="600"
                         style="width: 100%; height: 100%; object-fit: contain;" 
                         decoding="async" 
                         loading="lazy"
                         fetchpriority="low">
                </div>
                <div class="player-controls">
                    <button class="btn btn-secondary btn-sm" onclick="previous('video')" title="Previous Video">‚èÆÔ∏è</button>
                    <button class="btn btn-success btn-sm" onclick="play('video')" title="Play / Restart">‚ñ∂Ô∏è</button>
                    <button class="btn btn-warning btn-sm" onclick="pause('video')">‚è∏Ô∏è</button>
                    <button class="btn btn-danger btn-sm" onclick="stop('video')">‚èπÔ∏è</button>
                    <button class="btn btn-secondary btn-sm" onclick="next('video')" title="Next Video">‚è≠Ô∏è</button>
                    <button class="btn btn-outline-primary btn-sm" id="videoAutoplayBtn" onclick="toggleAutoplay('video')" title="Autoplay">üîÅ</button>
                    <button class="btn btn-outline-primary btn-sm" id="videoLoopBtn" onclick="toggleLoop('video')" title="Loop Playlist">üîÇ</button>
                </div>
            </div>
            
            <!-- Transition Menu (dynamically loaded) -->
            <div id="videoTransitionMenuContainer"></div>
            
            <!-- Playlist -->
            <div class="playlist-area">
                <div class="playlist-header" id="videoPlaylistHeader">
                    <span>üìπ Video Playlist</span>
                    <div class="master-toggle">
                        <label class="master-switch">
                            <input type="checkbox" id="videoMasterSwitch" onchange="toggleMasterPlaylist('video')">
                            <span class="master-slider"></span>
                        </label>
                        <span class="master-label" id="videoMasterLabel">Master</span>
                    </div>
                </div>
                <div class="playlist-scroll" id="videoPlaylist">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <p>No videos loaded</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Art-Net Player Section -->
        <div class="player-section">
            <!-- Preview -->
            <div class="preview-box">
                <div class="preview-video" id="artnetPreview" onclick="openArtnetFullscreen()" title="Click to open fullscreen">
                    <canvas id="artnetPreviewVideo" style="width: 100%; height: 100%; object-fit: contain; display: none;"></canvas>
                    <img src="" alt="Art-Net Preview" id="artnetPreviewImg" 
                         width="800" height="600"
                         style="width: 100%; height: 100%; object-fit: contain;" 
                         decoding="async" 
                         loading="lazy"
                         fetchpriority="low">
                </div>
                <div class="player-controls">
                    <button class="btn btn-secondary btn-sm" onclick="previous('artnet')" title="Previous Video">‚èÆÔ∏è</button>
                    <button class="btn btn-success btn-sm" onclick="play('artnet')" title="Play / Restart">‚ñ∂Ô∏è</button>
                    <button class="btn btn-warning btn-sm" onclick="pause('artnet')">‚è∏Ô∏è</button>
                    <button class="btn btn-danger btn-sm" onclick="stop('artnet')">‚èπÔ∏è</button>
                    <button class="btn btn-secondary btn-sm" onclick="next('artnet')" title="Next Generator">‚è≠Ô∏è</button>
                    <button class="btn btn-outline-primary btn-sm" id="artnetAutoplayBtn" onclick="toggleAutoplay('artnet')" title="Autoplay">üîÅ</button>
                    <button class="btn btn-outline-primary btn-sm" id="artnetLoopBtn" onclick="toggleLoop('artnet')" title="Loop Playlist">üîÇ</button>
                </div>
            </div>
            
            <!-- Transition Menu (dynamically loaded) -->
            <div id="artnetTransitionMenuContainer"></div>
            
            <!-- Playlist -->
            <div class="playlist-area">
                <div class="playlist-header" id="artnetPlaylistHeader">
                    <span>üé® Art-Net Playlist</span>
                    <div class="master-toggle">
                        <label class="master-switch">
                            <input type="checkbox" id="artnetMasterSwitch" onchange="toggleMasterPlaylist('artnet')">
                            <span class="master-slider"></span>
                        </label>
                        <span class="master-label" id="artnetMasterLabel">Master</span>
                    </div>
                </div>
                <div class="playlist-scroll" id="artnetPlaylist">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <p>No Art-Net sources loaded</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Middle Bar: BPM | TABS | AUDIO SEQUENCE -->
        <div class="middle-section">
            <!-- BPM Widget (Compact) -->
            <div class="middle-section-left">
                <div id="bpm-widget" class="bpm-widget-compact">
                    <div class="bpm-beat-indicator">
                        <div class="beat-dot" id="bpm-beat-dot"></div>
                    </div>
                    <div class="bpm-transport">
                        <button class="bpm-transport-btn" id="bpm-play-btn" title="Enable BPM Detection">‚ñ∂</button>
                        <button class="bpm-transport-btn" id="bpm-pause-btn" title="Pause">‚è∏</button>
                        <button class="bpm-transport-btn" id="bpm-stop-btn" title="Stop">‚èπ</button>
                    </div>
                    <div class="bpm-display-row">
                        <label class="bpm-label">BPM:</label>
                        <input type="number" id="bpm-value-input" class="bpm-value-input" min="20" max="300" step="0.1" value="" placeholder="--"/>
                    </div>
                    <button class="bpm-action-btn" id="bpm-tap-btn" title="Tap Tempo">üëÜ</button>
                    <button class="bpm-action-btn" id="bpm-resync-btn" title="Resync">üîÑ</button>
                </div>
            </div>
            
            <!-- Playlist Tabs (Center) -->
            <div class="middle-section-center">
                <div id="playlistTabsContainer"></div>
            </div>
            
            <!-- Audio Sequence Controls (Right) -->
            <div class="middle-section-right">
                <div class="audio-analyzer-controls">
                    <span class="audio-analyzer-status" id="globalAudioStatus" 
                          onclick="window.sequenceManager && window.sequenceManager.showAudioContextMenu(event)"
                          title="Audio Analyzer - Click for options"></span>
                    <div id="audioGainKnob" title="Input Gain (0.1x-5.0x)"></div>
                    <div id="beatSensitivityKnob" title="Beat Detection Sensitivity"></div>
                    <canvas id="globalAudioSpectrum" class="audio-spectrum-mini" width="80" height="24"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Bottom Section: Tabs + FX Controls -->
        <div class="bottom-section">
            <!-- Left Tabs Panel -->
            <div class="tabs-panel">
                <div class="tabs-header">
                    <button class="tab-btn" onclick="switchTab('effects')">Effects</button>
                    <button class="tab-btn" onclick="switchTab('sources')">Sources</button>
                    <button class="tab-btn active" onclick="switchTab('files')">Files</button>
                </div>
                <div class="tab-content">
                    <!-- Effects Tab -->
                    <div class="tab-pane" id="tab-effects">
                        <h6>Available Effects</h6>
                        <div id="effectsSearchContainer"></div>
                        <div id="availableEffects">
                            <div class="empty-state">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sources Tab -->
                    <div class="tab-pane" id="tab-sources">
                        <h6>Available Sources</h6>
                        <div id="sourcesSearchContainer"></div>
                        <div id="availableSources">
                            <div class="empty-state">
                                <p>Coming soon...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Files Tab -->
                    <div class="tab-pane active" id="tab-files">
                        <div id="filesSearchContainer"></div>
                        <div id="fileBrowser">
                            <div class="empty-state">
                                <p>Coming soon...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Layer Management Panel -->
            <div class="fx-panel" id="layerManagementPanel">
                <div class="fx-panel-header">
                    <span id="layerPanelTitle">üéûÔ∏è Layers</span>
                </div>
                <div class="fx-panel-body" id="layerPanelContent">
                    <div class="empty-state">
                        <p class="empty-state-hint">Ctrl+Linksklick auf Clip um Layer zu aktivieren</p>
                    </div>
                </div>
            </div>
            
            <!-- Video FX Control -->
            <div class="fx-panel">
                <div class="fx-panel-header">
                    <span>üé¨ Video FX</span>
                    <button class="btn btn-sm btn-danger btn-icon" onclick="clearVideoEffects()">üóëÔ∏è</button>
                </div>
                <div class="fx-panel-body" id="videoFxList">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <h6>No Effects</h6>
                        <p>Add effects from the left panel</p>
                    </div>
                </div>
            </div>
            
            <!-- Art-Net FX Control -->
            <div class="fx-panel">
                <div class="fx-panel-header">
                    <span>üí° Art-Net FX</span>
                    <button class="btn btn-sm btn-danger btn-icon" onclick="clearArtnetEffects()">üóëÔ∏è</button>
                </div>
                <div class="fx-panel-body" id="artnetFxList">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <h6>No Effects</h6>
                        <p>Add effects from the left panel</p>
                    </div>
                </div>
            </div>
            
            <!-- Clip FX Control (Unified for both players) -->
            <div class="fx-panel">
                <div class="fx-panel-header">
                    <span id="clipFxTitle">üé¨ Clip FX</span>
                    <button class="btn btn-sm btn-danger btn-icon" onclick="clearClipEffects()">üóëÔ∏è</button>
                </div>
                <div class="fx-panel-body" id="clipFxList">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <h6>No Clip Effects</h6>
                        <p>Select a clip to manage effects</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sequence Type Context Menu -->
    <div id="sequenceContextMenu" class="sequence-context-menu">
        <div class="sequence-context-menu-item" onclick="window.sequenceManager && window.sequenceManager.openEditorWithType('audio')">
            üéµ Audio Reactive
        </div>
        <div class="sequence-context-menu-item" onclick="window.sequenceManager && window.sequenceManager.openEditorWithType('timeline')">
            üìà Timeline
        </div>
        <div class="sequence-context-menu-item" onclick="window.sequenceManager && window.sequenceManager.openEditorWithType('bpm')">
            ü•Å BPM Sync
        </div>
        <div class="sequence-context-menu-divider"></div>
        <div class="sequence-context-menu-item danger" onclick="window.sequenceManager && window.sequenceManager.removeSequenceFromContext()">
            üóëÔ∏è Remove Sequence
        </div>
    </div>

    <!-- Audio Analyzer Context Menu -->
    <div id="audioAnalyzerContextMenu" class="sequence-context-menu">
        <div class="sequence-context-menu-item" onclick="window.sequenceManager && window.sequenceManager.toggleAudioAnalyzer()">
            <span id="audioToggleText">‚è∏Ô∏è Stop Analyzer</span>
        </div>
        <div class="sequence-context-menu-divider"></div>
        <div id="audioDeviceList">
            <!-- Populated dynamically -->
        </div>
    </div>



    <!-- Modals (before scripts to avoid DOM manipulation delays) -->
    
    <!-- Video Player Settings Modal -->
    <div class="modal fade" id="videoPlayerSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Video Player Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Resolution Setting -->
                    <div class="mb-3">
                        <label class="form-label">Resolution</label>
                        <select class="form-select bg-dark text-light border-secondary" id="videoResolutionPreset">
                            <option value="720p">1280x720 (720p)</option>
                            <option value="1080p" selected>1920x1080 (1080p)</option>
                            <option value="1440p">2560x1440 (1440p)</option>
                            <option value="2160p">3840x2160 (4K)</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    
                    <!-- Custom Resolution (hidden by default) -->
                    <div class="mb-3" id="videoCustomResolutionGroup" style="display: none;">
                        <label class="form-label">Custom Resolution</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="videoCustomWidth" placeholder="Width" min="640" max="7680">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="videoCustomHeight" placeholder="Height" min="480" max="4320">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Autosize Setting -->
                    <div class="mb-3">
                        <label class="form-label">Autosize Mode</label>
                        <select class="form-select bg-dark text-light border-secondary" id="videoAutosizeMode">
                            <option value="off" selected>Off (Letterbox)</option>
                            <option value="stretch">Stretch (Distort to fit)</option>
                            <option value="fill">Fill (Crop to fit)</option>
                            <option value="fit">Fit (Scale to fit)</option>
                        </select>
                        <small class="text-muted">How to handle videos that don't match the resolution</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVideoPlayerSettings()">Apply</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Art-Net Player Settings Modal -->
    <div class="modal fade" id="artnetPlayerSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Art-Net Player Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Resolution Setting -->
                    <div class="mb-3">
                        <label class="form-label">Resolution</label>
                        <select class="form-select bg-dark text-light border-secondary" id="artnetResolutionPreset">
                            <option value="720p">1280x720 (720p)</option>
                            <option value="1080p" selected>1920x1080 (1080p)</option>
                            <option value="1440p">2560x1440 (1440p)</option>
                            <option value="2160p">3840x2160 (4K)</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    
                    <!-- Custom Resolution (hidden by default) -->
                    <div class="mb-3" id="artnetCustomResolutionGroup" style="display: none;">
                        <label class="form-label">Custom Resolution</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="artnetCustomWidth" placeholder="Width" min="640" max="7680">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="artnetCustomHeight" placeholder="Height" min="480" max="4320">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Autosize Setting -->
                    <div class="mb-3">
                        <label class="form-label">Autosize Mode</label>
                        <select class="form-select bg-dark text-light border-secondary" id="artnetAutosizeMode">
                            <option value="off" selected>Off (Letterbox)</option>
                            <option value="stretch">Stretch (Distort to fit)</option>
                            <option value="fill">Fill (Crop to fit)</option>
                            <option value="fit">Fit (Scale to fit)</option>
                        </select>
                        <small class="text-muted">How to handle content that doesn't match the resolution</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveArtnetPlayerSettings()">Apply</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio File Browser Modal -->
    <div class="modal fade" id="sequencerFileBrowserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Select Audio File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Search/Filter -->
                    <div class="mb-3">
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="sequencerFileSearch" placeholder="Search files...">
                    </div>
                    
                    <!-- File List -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-dark table-hover">
                            <thead class="sticky-top bg-dark">
                                <tr>
                                    <th>Filename</th>
                                    <th>Folder</th>
                                    <th>Size</th>
                                </tr>
                            </thead>
                            <tbody id="sequencerFileList">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Playlist Modal -->
    <div class="modal fade" id="savePlaylistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Save Playlist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playlistNameInput" class="form-label">Playlist Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="playlistNameInput" 
                               placeholder="Enter playlist name..."
                               onkeypress="if(event.key==='Enter') confirmSavePlaylist()">
                        <small class="text-muted">A unique name for this playlist configuration</small>
                    </div>
                    <div class="alert alert-info border-secondary bg-dark">
                        <strong>‚ÑπÔ∏è Info:</strong> This will save both Video and Art-Net playlists together.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSavePlaylist()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div class="modal fade" id="createPlaylistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Create New Playlist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="createPlaylistNameInput" class="form-label">Playlist Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="createPlaylistNameInput" 
                               placeholder="Enter playlist name...">
                        <small class="text-muted">Enter a unique name for your new playlist</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmCreatePlaylistBtn">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Playlist Modal -->
    <div class="modal fade" id="renamePlaylistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Rename Playlist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="renamePlaylistNameInput" class="form-label">Playlist Name</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="renamePlaylistNameInput" 
                               placeholder="Enter new playlist name...">
                        <small class="text-muted">Enter a new name for this playlist</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmRenamePlaylistBtn">Rename</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Scripts After DOM Structure -->
    <!-- Critical Libraries MUST load first -->
    <script src="libs/jquery-3.6.0.min.js"></script>
    <script src="libs/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- UI Component Loaders (depend on jQuery/Bootstrap) -->
    <script src="js/toast-loader.js"></script>
    <script src="js/menu-loader.js"></script>
    <script src="js/transition-menu-loader.js"></script>
    <script src="js/modal-loader.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/session-state-manager.js"></script>
    <script src="js/search-filter-loader.js"></script>
    
    <!-- Non-critical libraries -->
    <script src="libs/ion-rangeslider/js/ion.rangeSlider.min.js"></script>
    <script src="libs/socket.io.min.js"></script>
    <script src="js/triple-slider.js"></script>

    <!-- Transport Custom UI -->
    <script src="js/transport-ui.js"></script>

    <!-- Component Scripts -->
    <script src="js/components/color-picker.js"></script>
    <script src="js/circular-slider.js"></script>
    <script src="js/sequences.js"></script>
    <script src="js/bpm-widget.js"></script>
    <script src="js/components/playlist-tabs.js"></script>
    <script src="js/player.js" type="module"></script>
    <script type="module" src="js/waveform-analyzer.js"></script>

    <script>
        // Page load timing (for debugging)
        (function() {
            const startTime = performance.now();
            
            window.addEventListener('load', () => {
                const totalTime = ((performance.now() - startTime) / 1000).toFixed(2);
                console.log(`‚ö° Page loaded in ${totalTime}s`);
            });
        })();
    </script>
    
    <!-- Emergency UI Unblock Script -->
    <script>
        // Safety measure: Ensure UI is always interactive after page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.body.style.pointerEvents = 'auto';
                document.body.style.userSelect = 'auto';
                
                // Only clean up modals on initial load, not during interaction
                if (!window._modalCleanupDone) {
                    window._modalCleanupDone = true;
                    
                    // Remove blocking Bootstrap modals that weren't properly hidden
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        // Only fix if modal is NOT actively shown
                        const style = getComputedStyle(modal);
                        if (style.display !== 'none' && !modal.classList.contains('show')) {
                            // Modal is in DOM but not shown - ensure it's hidden
                            modal.style.display = 'none';
                            modal.setAttribute('aria-hidden', 'true');
                        }
                    });
                    
                    // Remove any orphaned modal backdrops
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    
                    console.log('‚úÖ UI interaction safety check complete');
                }
            }, 1000); // Increased delay to ensure page is fully loaded
        });
    </script>
    </script>
    
    <script>
        // Sequencer Mode Toggle (exposed on window for state restoration)
        window.sequencerModeActive = false;
        
        async function toggleSequencerMode() {
            window.sequencerModeActive = !window.sequencerModeActive;
            const waveformSection = document.querySelector('.waveform-analyzer-section');
            const btn = document.getElementById('sequencerModeBtn');
            
            // Note: Button might not exist if using new UI, but function should still work
            if (!btn) {
                console.warn('Sequencer mode button not found (using new UI?), but continuing...');
            }
            
            try {
                // Call backend API to enable/disable master mode
                const response = await fetch('/api/sequencer/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: window.sequencerModeActive })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (window.sequencerModeActive) {
                        if (waveformSection) waveformSection.style.display = 'grid';
                        // Only update button if it exists (old UI)
                        if (btn) {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-success');
                            btn.textContent = 'üéµ Sequencer: MASTER';
                        }
                        console.log('‚úÖ Sequencer mode ENABLED (MASTER)');
                    } else {
                        if (waveformSection) waveformSection.style.display = 'none';
                        // Only update button if it exists (old UI)
                        if (btn) {
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-outline-secondary');
                            btn.textContent = 'üéµ Sequencer Mode';
                        }
                        console.log('‚úÖ Sequencer mode DISABLED');
                    }
                } else {
                    console.error('Failed to toggle sequencer mode');
                    // Revert state
                    window.sequencerModeActive = !window.sequencerModeActive;
                }
            } catch (error) {
                console.error('Error toggling sequencer mode:', error);
                // Revert state
                window.sequencerModeActive = !window.sequencerModeActive;
            }
        }
    </script>
</body>
</html>